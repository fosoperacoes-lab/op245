<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OP245-G Sinais v4.6</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #050a0e; --bg-sidebar: #0b1217; --bg-card: #0e161e;
            --border: #1c262e; --text-main: #e1e4e8; --text-dim: #707a8a;
            --green: #00c805; --red: #ff3b3b; --blue: #2196f3; --yellow: #f3ba2f;
            --cyan: #00e5ff;
        }

        /* Corre√ß√£o global de box-sizing para evitar vazamentos de layout */
        *, *::before, *::after { box-sizing: border-box; }

        body { 
            background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; 
            margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px;
        }

        /* HEADER */
        .top-nav {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: var(--bg-sidebar); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 1000;
        }

        /* SIDEBAR (MENU LATERAL) */
        #sidebar { 
            width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border); 
            padding: 65px 15px 15px; overflow-y: auto; height: 100%;
            transition: transform 0.3s ease, margin-left 0.3s ease;
        }
        #sidebar.hidden { margin-left: -320px; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* CONTE√öDO PRINCIPAL */
        #main { flex: 1; padding: 65px 15px 20px; overflow-y: auto; transition: 0.3s; width: 100%; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .section-header h3 { margin: 0; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .header-badge { background: var(--blue); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .header-badge.vela { background: #1e2329; border: 1px solid var(--border); color: var(--text-dim); }

        /* CARDS ESTAT√çSTICAS */
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); padding: 12px; border-radius: 6px; border: 1px solid var(--border); }
        .stat-card span { color: var(--text-dim); font-size: 11px; display: block; margin-bottom: 4px; white-space: nowrap; }
        .stat-card h2 { margin: 0; font-size: 18px; font-weight: 600; }

        /* TABELA DE SINAIS (COM SCROLL HORIZONTAL) */
        .table-section { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; 
            overflow-x: auto; /* Permite rolar a tabela em celulares */
            -webkit-overflow-scrolling: touch; /* Rolagem suave no iOS */
        }
        table { width: 100%; border-collapse: collapse; min-width: 750px; /* Trava a largura m√≠nima para as colunas n√£o sumirem */ }
        th { background: #0c141b; color: var(--text-dim); padding: 12px 10px; font-size: 10px; text-transform: uppercase; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 10px; border-bottom: 1px solid #141d26; font-size: 12px; white-space: nowrap; transition: 0.3s; }

        .badge-buy { color: var(--green); border: 1px solid var(--green); padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .badge-sell { color: var(--red); border: 1px solid var(--red); padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .status-conf { color: var(--blue); border: 1px solid var(--blue); padding: 2px 6px; border-radius: 12px; font-size: 10px; }
        .status-pend { color: var(--yellow); border: 1px solid var(--yellow); padding: 2px 6px; border-radius: 12px; font-size: 10px; }
        
        .icon-btn { cursor: pointer; font-size: 18px; padding: 6px; border-radius: 4px; transition: 0.2s; display: inline-flex; }
        .icon-btn:hover { background: var(--border); }
        
        /* GRIDS DE BOT√ïES */
        .grid-tags { display: grid; gap: 5px; margin-top: 8px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        .tag-btn { background: #1e2329; border: 1px solid var(--border); padding: 8px 4px; font-size: 10px; text-align: center; border-radius: 4px; cursor: pointer; color: var(--text-dim); transition: 0.2s; }
        .tag-btn.active { background: rgba(33, 150, 243, 0.15); border-color: var(--blue); color: var(--blue); font-weight: bold; }
        
        .chk-group { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .chk-label { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-main); cursor: pointer; }
        
        .config-block { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .config-block:last-child { border-bottom: none; }
        .slider-row { margin-top: 12px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
        .slider-header b { color: var(--text-main); font-weight: normal; }
        
        input[type="range"] { width: 100%; height: 3px; background: #2b3139; outline: none; -webkit-appearance: none; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--blue); border-radius: 50%; cursor: pointer; }
        input[type="range"]:disabled { opacity: 0.4; cursor: not-allowed; }
        input[type="range"]:disabled::-webkit-slider-thumb { background: #555; }

        /* POPUP DESIGN */
        #popup-container { position: fixed; top: 60px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .popup-alert { 
            padding: 15px; border-radius: 8px; width: 280px; 
            animation: slideIn 0.3s ease-out; pointer-events: all; box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            color: white; font-family: 'Inter', sans-serif; border: 1px solid rgba(255,255,255,0.2);
        }
        .popup-green { background: #00a004; }
        .popup-red { background: #d32f2f; }
        .popup-header { text-align: center; font-weight: 700; font-size: 14px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; }
        .popup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 11px; }
        .popup-grid span { opacity: 0.8; display: block; margin-bottom: 2px; }
        .popup-grid b { font-size: 14px; font-weight: 600; }

        @keyframes slideIn { from { transform: translateX(110%); } to { transform: translateX(0); } }
        @keyframes fadeOutRow { to { opacity: 0; transform: scale(0.98); } }

        /* MEDIA QUERIES PARA CELULARES E TABLETS */
        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); } /* Tablet: 3 colunas */
        }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); } /* Celular: 2 colunas */
            .stat-card h2 { font-size: 16px; }
            
            #sidebar {
                position: fixed; top: 50px; left: 0; height: calc(100vh - 50px);
                z-index: 1001; margin-left: 0; transform: translateX(0);
                box-shadow: 5px 0 20px rgba(0,0,0,0.8); width: 290px;
            }
            #sidebar.hidden { transform: translateX(-100%); }
            
            #popup-container {
                top: 60px; right: 0; left: 0; align-items: center; width: 100%;
            }
            .popup-alert { width: 90%; max-width: 320px; animation: slideDown 0.3s ease-out; }
            
            @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        }
    </style>
</head>
<body>

<nav class="top-nav">
    <div style="display:flex; align-items:center; gap:8px;">
        <span class="icon-btn" onclick="toggleSidebar()">‚öôÔ∏è</span>
        <span style="color:var(--blue); font-weight:bold; font-size: 14px;">OP245-G v4.6</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
        <span id="btn-audio" class="icon-btn" onclick="toggleAudio()">üîä</span>
        <span id="btn-pause" class="icon-btn" onclick="togglePause()">üîî</span>
        <div id="clock" style="font-weight: bold; font-family: monospace; color: var(--blue); font-size:12px;">00:00:00</div>
    </div>
</nav>

<div id="popup-container"></div>

<aside id="sidebar">
    <div class="config-block">
        <label style="font-size:11px; color:var(--text-dim); font-weight:bold; text-transform:uppercase;">Filtro de Vela</label>
        <div class="grid-tags grid-2">
            <div class="tag-btn active" id="vela-atual" onclick="toggleVela('Atual')">Vela Atual</div>
            <div class="tag-btn active" id="vela-prox" onclick="toggleVela('Pr√≥xima')">Pr√≥xima Vela</div>
        </div>
        <div class="chk-group">
            <label class="chk-label"><input type="checkbox" id="chk-popup" checked onchange="settings.popup = this.checked"> Mostrar Alertas Pop-up</label>
            <label class="chk-label"><input type="checkbox" id="chk-fechamento" onchange="settings.confirmClose = this.checked"> Confirmar no Fechamento</label>
        </div>
    </div>

    <div class="config-block">
        <label style="font-size:11px; color:var(--text-dim); font-weight:bold; text-transform:uppercase;">Timeframe</label>
        <div class="grid-tags grid-4" style="margin-bottom: 5px;">
            <div class="tag-btn tf-btn active" id="tf-M1" onclick="toggleTF('M1')">M1</div>
            <div class="tag-btn tf-btn active" id="tf-M5" onclick="toggleTF('M5')">M5</div>
            <div class="tag-btn tf-btn" id="tf-M10" onclick="toggleTF('M10')">M10</div>
            <div class="tag-btn tf-btn" id="tf-M15" onclick="toggleTF('M15')">M15</div>
        </div>
        <div class="tag-btn" id="btn-todas-tf" onclick="toggleAllTF()" style="width: 100%; display:block; padding: 6px 0;">Todas</div>
    </div>

    <div class="config-block">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="font-size:11px; color:var(--text-dim); font-weight:bold; text-transform:uppercase;">Pares Monitorados</label>
            <div style="display:flex; gap:5px;">
                <span style="font-size:9px; color:var(--blue); cursor:pointer;" onclick="bulkAssets(true)">Todos</span>
                <span style="font-size:9px; color:var(--text-dim); cursor:pointer;" onclick="bulkAssets(false)">Nenhum</span>
            </div>
        </div>
        <div class="grid-tags grid-3" id="asset-selector"></div>
    </div>

    <div class="config-block">
        <label style="font-size:11px; color:var(--text-dim); font-weight:bold; text-transform:uppercase;">RSI <span id="ind-lock-msg" style="color:var(--yellow); font-size:9px; display:none;">(Bloqueado)</span></label>
        <div class="slider-row"><div class="slider-header"><span>Per√≠odo:</span> <b id="val-rsi-p">14</b></div><input type="range" class="ind-slider" id="cfg-rsi-p" min="2" max="30" value="14" oninput="syncVal(this, 'val-rsi-p')"></div>
        <div class="slider-row"><div class="slider-header"><span>Sobrecompra:</span> <b id="val-rsi-up">80</b></div><input type="range" class="ind-slider" id="cfg-rsi-up" min="50" max="100" value="80" oninput="syncVal(this, 'val-rsi-up')"></div>
        <div class="slider-row"><div class="slider-header"><span>Sobrevenda:</span> <b id="val-rsi-dw">20</b></div><input type="range" class="ind-slider" id="cfg-rsi-dw" min="0" max="50" value="20" oninput="syncVal(this, 'val-rsi-dw')"></div>
    </div>

    <div class="config-block">
        <label style="font-size:11px; color:var(--text-dim); font-weight:bold; text-transform:uppercase;">MACD</label>
        <div class="slider-row"><div class="slider-header"><span>EMA R√°pida:</span> <b id="val-macd-f">12</b></div><input type="range" class="ind-slider" id="cfg-macd-f" min="5" max="30" value="12" oninput="syncVal(this, 'val-macd-f')"></div>
        <div class="slider-row"><div class="slider-header"><span>EMA Lenta:</span> <b id="val-macd-s">26</b></div><input type="range" class="ind-slider" id="cfg-macd-s" min="10" max="50" value="26" oninput="syncVal(this, 'val-macd-s')"></div>
        <div class="slider-row"><div class="slider-header"><span>Sinal:</span> <b id="val-macd-sig">9</b></div><input type="range" class="ind-slider" id="cfg-macd-sig" min="2" max="20" value="9" oninput="syncVal(this, 'val-macd-sig')"></div>
    </div>
</aside>

<main id="main">
    <div class="section-header">
        <h3>üìä Estat√≠sticas de Sinais <span id="stat-badges-tf"></span> <span id="stat-badges-vela"></span></h3>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><span>Total</span><h2 id="st-total">0</h2></div>
        <div class="stat-card"><span>Compra</span><h2 id="st-buy" style="color:var(--green)">0</h2></div>
        <div class="stat-card"><span>Venda</span><h2 id="st-sell" style="color:var(--red)">0</h2></div>
        <div class="stat-card"><span>Confirmados</span><h2 id="st-conf" style="color:var(--blue)">0</h2></div>
        <div class="stat-card"><span>Pendentes</span><h2 id="st-pend" style="color:var(--yellow)">0</h2></div>
        <div class="stat-card"><span>% Confirma√ß√£o</span><h2 id="st-rate" style="color:var(--cyan)">0.0%</h2></div>
    </div>

    <div class="table-section">
        <table>
            <thead>
                <tr><th>Hora Sinal</th><th>Par</th><th>Sinal</th><th>TF</th><th>Vela (Abertura)</th><th>Pre√ßo</th><th>RSI</th><th>Status</th></tr>
            </thead>
            <tbody id="signal-rows"></tbody>
        </table>
    </div>
</main>

<script>
    const ASSETS = ["EUR/USD", "GBP/USD", "AUD/CAD", "EUR/JPY", "BTC/USD", "ETH/USD", "XAUUSD", "SOL/USD", "EUR/CAD", "XRP/USD", "USD INDEX"];
    let selectedAssets = new Set(ASSETS);
    let selectedTFs = new Set(['M1', 'M5']);
    let selectedVelas = new Set(['Atual', 'Pr√≥xima']);
    
    let lockedSignals = new Map(); 
    let pendingSignalsList = [];   
    
    let settings = { popup: true, confirmClose: false };
    let isPaused = false;
    let isMuted = false;
    let stats = { total: 0, buy: 0, sell: 0, conf: 0, pend: 0 };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSignalSound(type) {
        if(isMuted) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(type === 'COMPRA' ? 1050 : 320, audioCtx.currentTime); 
        osc.type = type === 'COMPRA' ? 'sine' : 'triangle';
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.25);
    }

    function init() {
        // For√ßa fechar o menu no celular ao abrir a p√°gina
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('hidden');
        }

        document.getElementById('asset-selector').innerHTML = ASSETS.map(a => 
            `<div class="tag-btn active" id="ast-${a.replace(/[\/\s]/g,'')}" onclick="toggleAsset('${a}')">${a}</div>`
        ).join('');
        
        updateStatHeader();
        updatePresets();
        setInterval(updateClock, 1000);
        setInterval(generateSignal, 4000); 
        setInterval(checkPendingTimeouts, 1000);
    }

    function syncVal(el, targetId) { document.getElementById(targetId).innerText = el.value; }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
    function toggleAudio() { isMuted = !isMuted; document.getElementById('btn-audio').innerText = isMuted ? 'üîá' : 'üîä'; }
    function togglePause() { isPaused = !isPaused; document.getElementById('btn-pause').style.color = isPaused ? 'var(--red)' : 'var(--text-main)'; }
    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }

    function updateStatHeader() {
        document.getElementById('stat-badges-tf').innerHTML = Array.from(selectedTFs).map(tf => `<span class="header-badge">${tf}</span>`).join('');
        document.getElementById('stat-badges-vela').innerHTML = Array.from(selectedVelas).map(v => `<span class="header-badge vela">${v}</span>`).join('');
    }

    function setValues(p, up, dw, mf, ms, msig) {
        document.getElementById('cfg-rsi-p').value = p; syncVal(document.getElementById('cfg-rsi-p'), 'val-rsi-p');
        document.getElementById('cfg-rsi-up').value = up; syncVal(document.getElementById('cfg-rsi-up'), 'val-rsi-up');
        document.getElementById('cfg-rsi-dw').value = dw; syncVal(document.getElementById('cfg-rsi-dw'), 'val-rsi-dw');
        document.getElementById('cfg-macd-f').value = mf; syncVal(document.getElementById('cfg-macd-f'), 'val-macd-f');
        document.getElementById('cfg-macd-s').value = ms; syncVal(document.getElementById('cfg-macd-s'), 'val-macd-s');
        document.getElementById('cfg-macd-sig').value = msig; syncVal(document.getElementById('cfg-macd-sig'), 'val-macd-sig');
    }

    function updatePresets() {
        const hasTodas = selectedTFs.size === 4;
        const sliders = document.querySelectorAll('.ind-slider');
        const lockMsg = document.getElementById('ind-lock-msg');

        if (hasTodas) {
            sliders.forEach(s => s.disabled = true);
            lockMsg.style.display = 'inline';
            setValues(21, 80, 20, 21, 34, 9);
        } else {
            sliders.forEach(s => s.disabled = false);
            lockMsg.style.display = 'none';
            if (selectedTFs.size === 1) {
                if (selectedTFs.has('M1')) setValues(7, 85, 15, 7, 13, 9);
                else if (selectedTFs.has('M5')) setValues(14, 80, 20, 14, 26, 9);
                else if (selectedTFs.has('M10') || selectedTFs.has('M15')) setValues(21, 80, 20, 21, 34, 9);
            }
        }
        updateStatHeader();
    }

    function toggleVela(tipo) {
        const el = document.getElementById(tipo === 'Atual' ? 'vela-atual' : 'vela-prox');
        selectedVelas.has(tipo) ? (selectedVelas.delete(tipo), el.classList.remove('active')) : (selectedVelas.add(tipo), el.classList.add('active'));
        updateStatHeader();
    }

    function toggleTF(tf) {
        const el = document.getElementById(`tf-${tf}`);
        selectedTFs.has(tf) ? (selectedTFs.delete(tf), el.classList.remove('active')) : (selectedTFs.add(tf), el.classList.add('active'));
        document.getElementById('btn-todas-tf').classList.remove('active');
        updatePresets();
    }

    function toggleAllTF() {
        const allTFs = ['M1', 'M5', 'M10', 'M15'];
        const btn = document.getElementById('btn-todas-tf');
        
        if(btn.classList.contains('active')) {
            selectedTFs.clear();
            allTFs.forEach(tf => document.getElementById(`tf-${tf}`).classList.remove('active'));
            btn.classList.remove('active');
        } else {
            allTFs.forEach(tf => { selectedTFs.add(tf); document.getElementById(`tf-${tf}`).classList.add('active'); });
            btn.classList.add('active');
        }
        updatePresets();
    }

    function toggleAsset(a) {
        const el = document.getElementById(`ast-${a.replace(/[\/\s]/g,'')}`);
        selectedAssets.has(a) ? (selectedAssets.delete(a), el.classList.remove('active')) : (selectedAssets.add(a), el.classList.add('active'));
    }

    function bulkAssets(status) {
        ASSETS.forEach(a => {
            const el = document.getElementById(`ast-${a.replace(/[\/\s]/g,'')}`);
            status ? (selectedAssets.add(a), el.classList.add('active')) : (selectedAssets.delete(a), el.classList.remove('active'));
        });
    }

    function getCandleTime(tf, tipoVela) {
        const now = new Date();
        let min = now.getMinutes(), hrs = now.getHours();
        let step = parseInt(tf.replace('M', ''));
        let startMin = Math.floor(min / step) * step;
        if (tipoVela === 'Pr√≥xima') startMin += step;
        if (startMin >= 60) { startMin -= 60; hrs = (hrs + 1) % 24; }
        return `${hrs.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}:00`;
    }

    function updateStatsUI() {
        document.getElementById('st-total').innerText = stats.total;
        document.getElementById('st-buy').innerText = stats.buy;
        document.getElementById('st-sell').innerText = stats.sell;
        document.getElementById('st-conf').innerText = stats.conf;
        document.getElementById('st-pend').innerText = stats.pend;
        const rate = stats.total > 0 ? ((stats.conf / stats.total) * 100).toFixed(1) : "0.0";
        document.getElementById('st-rate').innerText = `${rate}%`;
    }

    function generateSignal() {
        if(isPaused || selectedAssets.size === 0 || selectedTFs.size === 0 || selectedVelas.size === 0) return;
        
        const pair = Array.from(selectedAssets)[Math.floor(Math.random() * selectedAssets.size)];
        const tf = Array.from(selectedTFs)[Math.floor(Math.random() * selectedTFs.size)];
        const velaType = Array.from(selectedVelas)[Math.floor(Math.random() * selectedVelas.size)];
        const candleTime = getCandleTime(tf, velaType);
        
        const signalKey = `${pair}_${tf}_${candleTime}`;
        if (lockedSignals.has(signalKey)) return; 
        if (Math.random() > 0.4) return; 

        lockedSignals.set(signalKey, true);

        const type = Math.random() > 0.5 ? 'COMPRA' : 'VENDA';
        const price = (Math.random() * 5000 + 100).toFixed(4);
        const rsi = (type === 'COMPRA' ? (Math.random() * 20 + 5) : (Math.random() * 20 + 80)).toFixed(1); 
        
        let isConfirmed = !settings.confirmClose || velaType === 'Atual';
        let rowId = 'row-' + Date.now();
        
        if (!isConfirmed) {
            pendingSignalsList.push({ id: rowId, pair, type, tf, candleTime, checked: false });
        }

        playSignalSound(type);
        if(settings.popup) showPopup(pair, type, tf, velaType, candleTime, price, rsi);

        stats.total++; 
        type === 'COMPRA' ? stats.buy++ : stats.sell++; 
        isConfirmed ? stats.conf++ : stats.pend++;
        updateStatsUI();

        const statusBadge = isConfirmed ? '<span class="status-conf">‚úì Confirmado</span>' : '<span class="status-pend">‚è≥ Pendente</span>';

        const row = `<tr id="${rowId}">
            <td>${new Date().toLocaleTimeString()}</td>
            <td><b>${pair}</b></td>
            <td><span class="${type === 'COMPRA' ? 'badge-buy' : 'badge-sell'}">${type}</span></td>
            <td><span style="background:var(--blue); padding:2px 5px; border-radius:3px; font-size:10px; color:white;">${tf}</span></td>
            <td style="font-family:monospace; font-size:12px;">${candleTime} <span style="font-size:9px; color:var(--text-dim)">(${velaType})</span></td>
            <td>${price}</td>
            <td style="color:${type === 'COMPRA' ? 'var(--green)' : 'var(--red)'}">${rsi}</td>
            <td class="status-cell">${statusBadge}</td>
        </tr>`;
        
        const tbody = document.getElementById('signal-rows');
        tbody.insertAdjacentHTML('afterbegin', row);
        if(tbody.children.length > 20) tbody.lastElementChild.remove();
        if(lockedSignals.size > 200) lockedSignals.clear();
    }

    function checkPendingTimeouts() {
        const now = new Date();
        for (let i = pendingSignalsList.length - 1; i >= 0; i--) {
            let sig = pendingSignalsList[i];
            if (sig.checked) continue;

            let parts = sig.candleTime.split(':');
            let targetDate = new Date();
            targetDate.setHours(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]), 0);

            let diffSec = (targetDate.getTime() - now.getTime()) / 1000;
            if (diffSec < -40000) { targetDate.setDate(targetDate.getDate() + 1); diffSec = (targetDate.getTime() - now.getTime()) / 1000; }

            let threshold = sig.tf === 'M1' ? 5 : (sig.tf === 'M5' ? 10 : 30);

            if (diffSec <= threshold && diffSec > 0) {
                sig.checked = true; 
                let currentRSI = Math.random() * 100;
                let isCanceled = (sig.type === 'VENDA' && currentRSI < 75) || (sig.type === 'COMPRA' && currentRSI > 25);
                let row = document.getElementById(sig.id);

                if (isCanceled) {
                    if (row) {
                        row.style.background = 'rgba(255,59,59,0.1)';
                        row.innerHTML = `<td colspan="8" style="text-align:center; color:var(--red);">Sinal Removido: Exaust√£o RSI Perdida (${sig.pair})</td>`;
                        row.style.animation = 'fadeOutRow 2.5s forwards';
                        setTimeout(() => row.remove(), 2500);
                    }
                    stats.total--; stats.pend--;
                    if (sig.type === 'COMPRA') stats.buy--; else stats.sell--;
                } else {
                    if (row) row.querySelector('.status-cell').innerHTML = '<span class="status-conf">‚úì Confirmado</span>';
                    stats.pend--; stats.conf++;
                }
                
                updateStatsUI();
                pendingSignalsList.splice(i, 1);
            }
        }
    }

    function showPopup(pair, type, tf, velaType, candleTime, price, rsi) {
        const id = Date.now();
        const popupClass = type === 'COMPRA' ? 'popup-green' : 'popup-red';
        const labelVela = velaType === 'Pr√≥xima' ? 'Pr√≥xima Vela:' : 'Vela Atual:';

        const html = `
            <div class="popup-alert ${popupClass}" id="${id}">
                <div class="popup-header">Sinal de ${type}</div>
                <div class="popup-grid">
                    <div><span>Ativo:</span><b>${pair}</b></div>
                    <div></div> 
                    <div><span>Timeframe:</span><b>${tf}</b></div>
                    <div><span>${labelVela}</span><b>${candleTime}</b></div>
                    <div><span>Pre√ßo:</span><b>${price}</b></div>
                    <div><span>RSI:</span><b>${rsi}</b></div>
                </div>
            </div>`;
            
        document.getElementById('popup-container').insertAdjacentHTML('afterbegin', html);
        setTimeout(() => document.getElementById(id)?.remove(), 5500);
    }

    init();
</script>
</body>
</html>